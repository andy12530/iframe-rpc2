/*! rpc2 2014-07-20 */
var $=require("jquery"),channelCounter=0,Events=require("Events.js"),emptyFn=function(){},isFunction=function(a){return"function"==typeof a},RPC=function(a){function b(a){var b,c=e[a.method];if(isFunction(c)){try{"[object Array]"!==Object.prototype.toString.call(a.params)&&(a.params=[a.params]),b=c.apply({},a.params)}catch(d){throw new Error("Exec function error: "+d.message)}a.callbackId&&h({callbackId:a.callbackId,result:b})}}var c=this;a=a||{},a.isHost=a.remote?!0:!1,a.channel=a.isHost&&window.name?"RPC_CHANNEL_P"+channelCounter++:"RPC_CHANNEL_"+channelCounter++,a.protocol=window.postMessage||document.postMessage?"1":"2";var d={},e=a.method||{},f=1;Events.mixTo(RPC.Transport.prototype);var g=new RPC.Transport(a),h=function(a){g.send(a)};g.on("ready",function(){isFunction(a.onReady)&&setTimeout(function(){a.onReady.call(c)},0)}),g.on("message",function(a){if(a.method)b(a);else if(a.callbackId){var c=d[a.callbackId];c&&c(a.result)}});var i=function(a,b,c){var e={jsonrpc:"2.0",params:b,method:a,callbackId:f};isFunction(b)&&(c=b),isFunction(c)&&(d[f]=c),f++,setTimeout(function(){h(e)},0)};return i.set=function(a,b){e[a]=b},i.destroy=function(){f=0,e={},d={},g.destroy()},g.init(),i.iframe=a.iframe,i};RPC.behavior={},function(a){a.FLAG="__RPC__",a.handleMessage=function(b){return a.FLAG+JSON.stringify(b)},a.verify=function(b){var c={message:void 0,trust:!1};return 0===b.indexOf(a.FLAG)&&(c.message=b.replace(a.FLAG,""),c.trust=!0),c},a.navigator=function(b,c){var d={incoming:function(e){var f=a.verify(e);!0===f.trust&&(e=f.message,'"ready"'===e?(c.emit("ready"),b.isHost&&d.outgoing("ready")):c.emit("message",JSON.parse(e)))},outgoing:function(c){c=a.handleMessage(c),b.isHost?window.navigator[b.channel+"_remote"](c):window.navigator[b.channel+"_host"](c)},init:function(){b.isHost?window.navigator[b.channel+"_host"]=d.incoming:(window.navigator[b.channel+"_remote"]=d.incoming,d.outgoing("ready"))}};return d},a.postMessage=function(b,c){var d,e={incoming:function(a){a.channel===b.channel&&c.emit("message",a)},outgoing:function(c){"ready"===c?c={channel:b.channel,isReady:!0}:c.channel=b.channel,c=a.handleMessage(c),d.postMessage(c,"*")},init:function(){if($(window).on("message",function(d){var f=d.data,g=a.verify(f);!0===g.trust&&(f=g.message,f=JSON.parse(f),f.channel===b.channel&&(f.isReady?(b.isHost&&e.outgoing("ready"),c.emit("ready")):e.incoming(f)))}),b.isHost){var f=b.iframe;d="postMessage"in f.contentWindow?f.contentWindow:f.contentWindow.document}else d="postMessage"in window.parent?window.parent:window.parent.document,e.outgoing("ready")}};return e}}(RPC.behavior),function(a){var b=function(a,c,d){for(var e in c)if(e in a){var f=c[e];"object"==typeof f?b(a[e],f,d):d&&(a[e]=c[e])}else a[e]=c[e];return a},c=function(a){var c=null;try{c=document.createElement('<IFRAME name="'+a.channel+'">')}catch(d){}return c&&"IFRAME"===c.nodeName||(c=document.createElement("IFRAME"),c.name=a.channel),a.props=a.props||{},"string"==typeof a.container&&(a.container=document.getElementById(a.container)),b(c.style,a.props.style,!0),a.container||b(c.style,{position:"absolute",top:"-2000px",left:"0px"},!0),a.props.src="javascript:false",b(c,a.props,!0),c.border=c.frameBorder=0,c.allowTransparency=!0,a.container?a.container.appendChild(c):(a.container=document.body,$("body").prepend(c)),c.src=a.remote,c};a.Transport=function(b){var d=this,e=[],f=[];switch(Events.mixTo(this),b.isHost||(b.channel=window.name),b.protocol){case"1":e=new a.behavior.postMessage(b,d);break;case"2":e=new a.behavior.navigator(b,d)}b.onLoad=function(){e.init()},this.on("ready",function(){d.send=function(a){e.outgoing(a)};for(var a=0;a<f.length;a++)d.send(f[a])}),this.init=function(){b.isHost&&(b.iframe=c(b)),b.onLoad()},this.send=function(a){f.push(a)},this.destroy=function(){b.iframe.parentNode.removeChild(b.iframe)}}}(RPC);